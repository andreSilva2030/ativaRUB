{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h3 class="mb-4">Criar Checkpoint de Atividade</h3>

  <form method="POST">

    <!-- Card: Informações Básicas -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header">Informações Básicas</div>
      <div class="card-body">

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">Título *</label>
            <input type="text" class="form-control" name="nome_checkpoint" required>
          </div>
        </div>

        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Status</label>
            <select class="form-select" name="status">
              <option>Pendente</option>
              <option>Em andamento</option>
              <option>Concluído</option>
            </select>
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label">Data Inicial *</label>
            <input type="datetime-local" class="form-control" name="data_ini" required>
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label">Data Final</label>
            <input type="datetime-local" class="form-control" name="data_fim">
          </div>
        </div>

      </div>
    </div>

    <!-- Card: Planejamento -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header">Planejamento</div>
      <div class="card-body">

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">Grupo de Trabalho *</label>
            <select class="form-select" id="id_grupo_trabalho" name="id_grupo_trabalho" required>
              <option value="">Selecione</option>
              {% for grupo in grupos_trabalho %}
                <option value="{{ grupo.id_grupo_trabalho }}">{{ grupo.nome_grupo }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">Planejamento *</label>
            <select class="form-select" id="id_planejamento" name="id_planejamento" required>
              <option value="">Selecione</option>
              {% for planejamento in planejamentos %}
                <option value="{{ planejamento.id_planejamento }}" data-grupo="{{ planejamento.grupo_trabalho.id_grupo_trabalho }}">
                  {{ planejamento.titulo }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

      </div>
    </div>

    <!-- Lojas -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header">Lojas Associadas</div>
      <div class="card-body">
        <div id="lojas-container" class="lojas-box">
          <p class="text-muted">Selecione um grupo de trabalho.</p>
        </div>
      </div>
    </div>

    <!-- Observação -->
    <div class="mb-3">
      <label class="form-label">Observação</label>
      <textarea class="form-control" rows="3" name="observacao"></textarea>
    </div>

    <!-- Ações -->
    <div class="d-flex justify-content-end gap-2">
      <button class="btn btn-primary">Salvar</button>
      <a href="{{ url_for('checkpoint_atividade.index') }}" class="btn btn-outline-secondary">Cancelar</a>
    </div>

  </form>
</div>


<script>
    // Atualizar as lojas associadas ao grupo de trabalho selecionado
    document.getElementById('id_grupo_trabalho').addEventListener('change', function () {
        const grupoId = this.value;
        const lojasContainer = document.getElementById('lojas-container');

        // Limpar o container de lojas
        lojasContainer.innerHTML = '<p class="text-muted">Carregando lojas...</p>';

        if (grupoId) {
            fetch(`/lojas/api/lojas?grupo_trabalho_id=${grupoId}`)
                .then(response => response.json())
                .then(data => {
                    lojasContainer.innerHTML = ''; // Limpar o container novamente

                    if (data.length > 0) {
                        // Adicionar o checkbox "Selecionar Todas"
                        const selectAllCheckbox = document.createElement('input');
                        selectAllCheckbox.type = 'checkbox';
                        selectAllCheckbox.id = 'select-all-lojas';
                        selectAllCheckbox.classList.add('form-check-input');

                        const selectAllLabel = document.createElement('label');
                        selectAllLabel.htmlFor = 'select-all-lojas';
                        selectAllLabel.textContent = 'Selecionar Todas';
                        selectAllLabel.classList.add('form-check-label');

                        const selectAllDiv = document.createElement('div');
                        selectAllDiv.classList.add('form-check', 'mb-2');
                        selectAllDiv.appendChild(selectAllCheckbox);
                        selectAllDiv.appendChild(selectAllLabel);

                        lojasContainer.appendChild(selectAllDiv);

                        // Adicionar evento para "Selecionar Todas"
                        selectAllCheckbox.addEventListener('change', function () {
                            const checkboxes = lojasContainer.querySelectorAll('input[type="checkbox"]:not(#select-all-lojas)');
                            checkboxes.forEach(checkbox => {
                                checkbox.checked = this.checked;
                            });
                        });

                        // Adicionar os checkboxes das lojas
                        data.forEach(loja => {
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.name = 'lojas';
                            checkbox.value = loja.id_loja;
                            checkbox.id = `loja-${loja.id_loja}`;
                            checkbox.classList.add('form-check-input');

                            const label = document.createElement('label');
                            label.htmlFor = `loja-${loja.id_loja}`;
                            label.textContent = loja.nome_loja;
                            label.classList.add('form-check-label');

                            const div = document.createElement('div');
                            div.classList.add('form-check');
                            div.appendChild(checkbox);
                            div.appendChild(label);

                            lojasContainer.appendChild(div);
                        });
                    } else {
                        lojasContainer.innerHTML = '<p class="text-muted">Nenhuma loja associada a este grupo de trabalho.</p>';
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar lojas:', error);
                    lojasContainer.innerHTML = '<p class="text-danger">Erro ao carregar lojas. Tente novamente.</p>';
                });
        } else {
            lojasContainer.innerHTML = '<p class="text-muted">Selecione um grupo de trabalho para ver as lojas associadas.</p>';
        }
    });

    // Atualizar os planejamentos com base no grupo de trabalho selecionado
    document.getElementById('id_grupo_trabalho').addEventListener('change', function () {
        const grupoId = this.value;
        const planejamentoSelect = document.getElementById('id_planejamento');
        const options = planejamentoSelect.querySelectorAll('option');

        // Mostrar apenas os planejamentos associados ao grupo selecionado
        options.forEach(option => {
            if (option.dataset.grupo === grupoId || option.value === '') {
                option.style.display = '';
            } else {
                option.style.display = 'none';
            }
        });

        // Resetar o valor do campo de planejamento
        planejamentoSelect.value = '';
    });
</script>
{% endblock %}
