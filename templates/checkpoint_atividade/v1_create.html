{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Criar Checkpoint de Atividade</h2>

    <form method="POST">
        <!-- Título -->
        <div class="mb-3">
            <label for="nome_checkpoint" class="form-label">Título *</label>
            <input type="text" class="form-control" id="nome_checkpoint" name="nome_checkpoint" required>
        </div>

        <!-- Atividade -->
        <div class="mb-3">
            <label for="id_atividade" class="form-label">Atividade *</label>
            <select class="form-select" id="id_atividade" name="id_atividade" required>
                <option value="">Selecione uma atividade</option>
                {% for atividade in atividades %}
                    <option value="{{ atividade.id_atividade }}">{{ atividade.titulo }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Status -->
        <div class="mb-3">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" id="status" name="status">
                <option value="Pendente">Pendente</option>
                <option value="Em andamento">Em andamento</option>
                <option value="Concluído">Concluído</option>
            </select>
        </div>

        <!-- Grupo de Trabalho -->
        <div class="mb-3">
            <label for="id_grupo_trabalho" class="form-label">Grupo de Trabalho *</label>
            <select class="form-select" id="id_grupo_trabalho" name="id_grupo_trabalho" required>
                <option value="">Selecione um grupo de trabalho</option>
                {% for grupo in grupos_trabalho %}
                    <option value="{{ grupo.id_grupo_trabalho }}">{{ grupo.nome_grupo }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Planejamento -->
        <div class="mb-3">
            <label for="id_planejamento" class="form-label">Planejamento *</label>
            <select class="form-select" id="id_planejamento" name="id_planejamento" required>
                <option value="">Selecione um planejamento</option>
                {% for planejamento in planejamentos %}
                    <option value="{{ planejamento.id_planejamento }}" data-grupo="{{ planejamento.grupo_trabalho.id_grupo_trabalho }}">
                        {{ planejamento.titulo }} - {{ planejamento.data_ini.strftime('%Y-%m-%dT%H:%M') }} a {{ planejamento.data_fim.strftime('%Y-%m-%dT%H:%M') if planejamento.data_fim else 'Sem data final' }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Lojas Associadas -->
        <div class="mb-3">
            <label class="form-label">Lojas Associadas</label>
            <div id="lojas-container">
                <p class="text-muted">Selecione um grupo de trabalho para ver as lojas associadas.</p>
            </div>
        </div>

        <!-- Data Inicial -->
        <div class="mb-3">
            <label for="data_ini" class="form-label">Data Inicial *</label>
            <input type="datetime-local" class="form-control" id="data_ini" name="data_ini" required>
        </div>

        <!-- Data Final -->
        <div class="mb-3">
            <label for="data_fim" class="form-label">Data Final</label>
            <input type="datetime-local" class="form-control" id="data_fim" name="data_fim">
        </div>

        <!-- Observação -->
        <div class="mb-3">
            <label for="observacao" class="form-label">Observação</label>
            <textarea class="form-control" id="observacao" name="observacao" rows="3"></textarea>
        </div>

        <!-- Botões -->
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Salvar</button>
            <a href="{{ url_for('checkpoint_atividade.index') }}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

<script>
    // Atualizar as lojas associadas ao grupo de trabalho selecionado
    document.getElementById('id_grupo_trabalho').addEventListener('change', function () {
        const grupoId = this.value;
        const lojasContainer = document.getElementById('lojas-container');

        // Limpar o container de lojas
        lojasContainer.innerHTML = '<p class="text-muted">Carregando lojas...</p>';

        if (grupoId) {
            fetch(`/lojas/api/lojas?grupo_trabalho_id=${grupoId}`)
                .then(response => response.json())
                .then(data => {
                    lojasContainer.innerHTML = ''; // Limpar o container novamente

                    if (data.length > 0) {
                        // Adicionar o checkbox "Selecionar Todas"
                        const selectAllCheckbox = document.createElement('input');
                        selectAllCheckbox.type = 'checkbox';
                        selectAllCheckbox.id = 'select-all-lojas';
                        selectAllCheckbox.classList.add('form-check-input');

                        const selectAllLabel = document.createElement('label');
                        selectAllLabel.htmlFor = 'select-all-lojas';
                        selectAllLabel.textContent = 'Selecionar Todas';
                        selectAllLabel.classList.add('form-check-label');

                        const selectAllDiv = document.createElement('div');
                        selectAllDiv.classList.add('form-check', 'mb-2');
                        selectAllDiv.appendChild(selectAllCheckbox);
                        selectAllDiv.appendChild(selectAllLabel);

                        lojasContainer.appendChild(selectAllDiv);

                        // Adicionar evento para "Selecionar Todas"
                        selectAllCheckbox.addEventListener('change', function () {
                            const checkboxes = lojasContainer.querySelectorAll('input[type="checkbox"]:not(#select-all-lojas)');
                            checkboxes.forEach(checkbox => {
                                checkbox.checked = this.checked;
                            });
                        });

                        // Adicionar os checkboxes das lojas
                        data.forEach(loja => {
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.name = 'lojas';
                            checkbox.value = loja.id_loja;
                            checkbox.id = `loja-${loja.id_loja}`;
                            checkbox.classList.add('form-check-input');

                            const label = document.createElement('label');
                            label.htmlFor = `loja-${loja.id_loja}`;
                            label.textContent = loja.nome_loja;
                            label.classList.add('form-check-label');

                            const div = document.createElement('div');
                            div.classList.add('form-check');
                            div.appendChild(checkbox);
                            div.appendChild(label);

                            lojasContainer.appendChild(div);
                        });
                    } else {
                        lojasContainer.innerHTML = '<p class="text-muted">Nenhuma loja associada a este grupo de trabalho.</p>';
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar lojas:', error);
                    lojasContainer.innerHTML = '<p class="text-danger">Erro ao carregar lojas. Tente novamente.</p>';
                });
        } else {
            lojasContainer.innerHTML = '<p class="text-muted">Selecione um grupo de trabalho para ver as lojas associadas.</p>';
        }
    });

    // Atualizar os planejamentos com base no grupo de trabalho selecionado
    document.getElementById('id_grupo_trabalho').addEventListener('change', function () {
        const grupoId = this.value;
        const planejamentoSelect = document.getElementById('id_planejamento');
        const options = planejamentoSelect.querySelectorAll('option');

        // Mostrar apenas os planejamentos associados ao grupo selecionado
        options.forEach(option => {
            if (option.dataset.grupo === grupoId || option.value === '') {
                option.style.display = '';
            } else {
                option.style.display = 'none';
            }
        });

        // Resetar o valor do campo de planejamento
        planejamentoSelect.value = '';
    });
</script>
{% endblock %}
